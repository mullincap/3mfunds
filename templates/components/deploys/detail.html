{% extends "layouts/base.html" %}

{% block content %}

<style>
    .deploy-detail-layout {
        display: flex;
        width: 100%;
        align-items: flex-start;
        gap: 20px;
        padding-left: 3% !important;
        padding-right: 3% !important;

    }

    .deploys-sidebar .active {
        background: #1a1c20 !important;
    }

    .deploys-sidebar a:hover {
        background: #1e2025;
    }
    .deploys-sidebar a.active {
        background: #14161a !important;
        position: relative;
    }

    .deploys-sidebar a.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 8px;
        bottom: 8px;
        width: 4px;
        border-radius: 2px;
        background: var(--primary-color, #5e76ff);
    }
    .kpi-card i {
    color: #000 !important;
}
</style>

<div class="deploy-detail-layout mt-2">

    <!-- SIDEBAR -->
    <div class="card custom-card deploys-sidebar me-3"
         style="width:260px; height:calc(100vh - 80px); position:sticky; top:80px; overflow-y:auto;">

        <div class="card-header justify-content-between">
            <div class="card-title mb-0">Deploys</div>
            <span class="text-muted fs-12">UTC</span>
        </div>

        <div class="card-body p-0">
            <ul class="list-unstyled my-stocks-ul mb-0">

                {% for d in deploys_list %}
                <li class="m-0 p-0">
                    <a href="{{ url_for('deploy_detail', deploy_id=d.id) }}"
                       class="d-flex align-items-center flex-fill lh-1 p-3 {% if d.id == deploy.id %}active{% endif %}"
                       style="text-decoration:none; border-bottom:1px solid #1e1f25;">

                        <div class="me-3">
                            <span class="avatar avatar-rounded bg-light p-2">
                                {{ d.timestamp_utc.strftime('%a')[0] }}
                            </span>
                        </div>

                        <div class="lh-1 flex-fill">
                            <span class="fw-semibold d-block">
                                {{ d.timestamp_utc.strftime('%b %d') }}
                            </span>
                            <span class="d-block text-muted fs-12">
                                {{ d.timestamp_utc.strftime('%A') }}
                            </span>
                        </div>

                        <div class="text-end fs-12 text-muted"></div>

                    </a>
                </li>
                {% endfor %}

            </ul>
        </div>

    </div>

    <!-- RIGHT SIDE CONTENT -->
    <div class="deploy-content" style="flex:1;">

        <!-- HEADER + KPIs -->
        <div class="card custom-card mb-4">

            <div class="card-header">
                <h3 class="card-title">
                    Deploy {{ deploy.id }} — {{ deploy.timestamp_utc }}
                </h3>
                <p class="text-muted mb-0">
                    Portfolio of {{ deploy.R1 }}, {{ deploy.R2 }}, {{ deploy.R3 }} … (up to 30 assets)
                </p>
            </div>

            <!-- KPI ROW -->
            <div class="card-body">

                <div class="row g-3">

                    <!-- Return -->
                    <div class="col-xl-2 col-lg-4 col-md-6 col-sm-12">
                        <div class="p-3 card custom-card border bg-white rounded kpi-card">
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-rounded bg-success me-3 p-2">
                                    <i class="ti ti-chart-line text-white fs-18"></i>
                                </span>
                                <div>
                                    <div class="fw-semibold">Return</div>
                                    <div class="text-muted fs-12">
                                        {{ "%.2f"|format(total_return_pct) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BTC Perf -->
                    <div class="col-xl-2 col-lg-4 col-md-6 col-sm-12">
                        <div class="p-3 card custom-card border bg-white rounded kpi-card">
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-rounded bg-warning me-3 p-2">
                                    <i class="bi bi-currency-bitcoin fs-18"></i>
                                </span>
                                <div>
                                    <div class="fw-semibold">BTC Perf</div>
                                    <div class="text-muted fs-12">
                                        {{ "%.2f"|format(btc_perf_pct) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Max DD -->
                    <div class="col-xl-2 col-lg-4 col-md-6 col-sm-12">
                        <div class="p-3 card custom-card border bg-white rounded kpi-card">
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-rounded bg-danger me-3 p-2">
                                    <i class="ti ti-trending-down fs-18 text-white"></i>
                                </span>
                                <div>
                                    <div class="fw-semibold">Max DD</div>
                                    <div class="text-muted fs-12">
                                        {{ "%.2f"|format(max_dd_pct) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lowest ROI (Worst Dip) -->
                    <div class="col-xl-2 col-lg-4 col-md-6 col-sm-12">
                        <div class="p-3 card custom-card border bg-white rounded kpi-card">
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-rounded bg-secondary me-3 p-2">
                                    <i class="ti ti-trending-down fs-18 text-white"></i>
                                </span>
                                <div>
                                    <div class="fw-semibold">Lowest ROI</div>
                                    <div class="text-muted fs-12">
                                        {{ "%.2f"|format(lowest_roi_pct) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Avg ROI -->
                    <div class="col-xl-2 col-lg-4 col-md-6 col-sm-12">
                        <div class="p-3 card custom-card border bg-white rounded kpi-card">
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-rounded bg-info me-3 p-2">
                                    <i class="ti ti-percentage fs-18"></i>
                                </span>
                                <div>
                                    <div class="fw-semibold">Avg ROI</div>
                                    <div class="text-muted fs-12">
                                        {{ "%.2f"|format(avg_roi_pct) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stop Losses -->
                    <div class="col-xl-2 col-lg-4 col-md-6 col-sm-12">
                        <div class="p-3 card custom-card border bg-white rounded kpi-card">
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-rounded bg-danger me-3 p-2">
                                    <i class="ti ti-arrow-down text-white fs-18"></i>
                                </span>
                                <div>
                                    <div class="fw-semibold">Stop Losses</div>
                                    <div class="text-muted fs-12">
                                        {{ stop_loss_count }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div><!-- row -->

            </div><!-- card-body -->
        </div><!-- card -->

        <!-- ROI CHART -->
        <div class="card custom-card mb-4">
            <div class="card-header"><h4 class="card-title">Portfolio ROI</h4></div>
            <div class="card-body">
                <div id="deploy-roi-chart" style="height: 350px;"></div>
            </div>
        </div>

        <!-- ASSET ROI CHART -->
        <div class="card custom-card mb-4">
            <div class="card-header"><h4 class="card-title">Asset-Level ROI Curves</h4></div>
            <div class="card-body">
                <div id="asset-roi-chart" style="height: 450px;"></div>
            </div>
        </div>

    </div>
</div>

<!-- Pass Data to JS -->
<script>
    const ts = {{ timestamps|tojson }};
    const balance = {{ balance|tojson }};
    const roi = {{ roi|tojson }};
    const assetSeries = {{ asset_series|tojson }};
</script>

<script src="{{ url_for('static', filename='assets/libs/apexcharts/apexcharts.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/deploy_detail.js') }}"></script>

{% endblock %}
